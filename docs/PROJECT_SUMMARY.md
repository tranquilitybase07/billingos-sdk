# BillingOS SDK - Project Summary

## ğŸ“‹ Overview

Building a React SDK for embedded billing experiences:
- **Pricing Table** - Show subscription plans
- **Payment Widget** - Collect payments (Apple Pay, cards)
- **Customer Portal** - Manage subscriptions
- **Upgrade Nudges** - Proactive upgrade prompts

**Timeline:** 4-6 weeks
**Status:** Ready to start - all specs complete

---

## ğŸ¯ What Makes This SDK Special

### 1. Embedded Everything (No Redirects)
- **Pricing** â†’ Modal checkout (not redirect to Stripe)
- **Payment** â†’ Bottom sheet with Apple Pay (mobile-first)
- **Portal** â†’ Drawer in merchant's app (not separate portal)

### 2. Plug & Play
```tsx
// Merchant's code - that's it!
<BillingOSProvider apiKey="pk_live_..." customerToken="...">
  <PricingTable />
  <CustomerPortal />
</BillingOSProvider>
```

### 3. Beautiful Defaults
- Pre-designed components (light/dark themes)
- Responsive (mobile/tablet/desktop)
- Accessible (keyboard nav, screen readers)

---

## ğŸ—ï¸ Architecture

### Authentication Flow

```
Merchant Backend
    â”‚
    â”‚ 1. Create customer token
    â”‚    POST /sdk/customer-tokens
    â”‚    (uses sk_live_... secret key)
    â”‚
    â–¼
Returns JWT token
    â”‚
    â”‚ 2. Pass to frontend
    â”‚
    â–¼
Merchant Frontend
    â”‚
    â”‚ 3. Initialize SDK
    â”‚    <BillingOSProvider
    â”‚      apiKey="pk_live_..."
    â”‚      customerToken="eyJhbGc..."
    â”‚    >
    â”‚
    â–¼
SDK makes API calls
    â”‚
    â”‚ 4. All requests include:
    â”‚    â€¢ X-BillingOS-API-Key: pk_live_...
    â”‚    â€¢ Authorization: Bearer eyJhbGc...
    â”‚
    â–¼
BillingOS Backend
    â”‚
    â”‚ 5. Validates:
    â”‚    â€¢ API key â†’ which organization
    â”‚    â€¢ Customer token â†’ which customer
    â”‚    â€¢ Stripe account â†’ org's Connect ID
    â”‚
    â–¼
Returns scoped data
```

**Security:**
- Publishable key safe in frontend (like Stripe's `pk_`)
- Customer token is short-lived JWT (1 hour)
- Merchant controls who gets tokens
- BillingOS validates + scopes data

---

## ğŸ“¦ Components to Build

### 1. PricingTable
**Complexity:** â­ Easy
**Time:** 1 week
**Files:**
- `src/components/PricingTable.tsx`
- Dummy data in `docs/component-specs/pricing-table-spec.md`

**Features:**
- Grid of subscription plans
- Features list per plan
- Monthly/yearly toggle
- Current plan highlighted
- "Buy Now" / "Upgrade" buttons

### 2. PaymentBottomSheet
**Complexity:** â­â­â­ Hard (Stripe integration)
**Time:** 2 weeks
**Files:**
- `src/components/PaymentBottomSheet.tsx`
- Uses `@stripe/react-stripe-js`

**Features:**
- Slide-up animation (mobile-first)
- Stripe Express Checkout (Apple Pay, Google Pay)
- Traditional card form (Stripe Payment Element)
- Proration preview for upgrades
- Success/error handling

### 3. CustomerPortal
**Complexity:** â­â­â­â­ Very Hard (most complex)
**Time:** 2-3 weeks
**Files:**
- `src/components/CustomerPortal.tsx`
- Multiple tabs and modals

**Features:**
- **Subscription tab** - Current plan, usage bars, upgrade/cancel
- **Invoices tab** - List, download PDFs, retry failed payments
- **Payment tab** - Saved cards, add/remove methods
- **Settings tab** - Billing address, email

### 4. UpgradeNudge
**Complexity:** â­â­ Medium
**Time:** 1 week
**Files:**
- `src/components/UpgradeNudge.tsx`

**Features:**
- Banner / Toast / Modal styles
- Triggered by usage thresholds (80%, 90%, 95%)
- Shows suggested plan with features
- Auto-dismiss logic
- Frequency limits (don't spam)

---

## ğŸ“š Documentation Structure

```
docs/
â”œâ”€â”€ GETTING_STARTED.md          â† Developer setup guide
â”œâ”€â”€ PROJECT_SUMMARY.md           â† This file
â”œâ”€â”€ authentication-flow.md       â† JWT auth system
â”œâ”€â”€ api-integration.md           â† All backend endpoints
â””â”€â”€ component-specs/
    â”œâ”€â”€ pricing-table-spec.md    â† Dummy data + UI mockup
    â”œâ”€â”€ payment-bottom-sheet-spec.md
    â”œâ”€â”€ customer-portal-spec.md
    â””â”€â”€ upgrade-nudge-spec.md
```

**Each spec includes:**
- Full dummy JSON data
- UI mockup (ASCII art)
- Props interface (TypeScript)
- API endpoints
- Component states
- Testing checklist

---

## ğŸ”„ Data Flow

### Where Data Comes From

| Data Type | Source | Why |
|-----------|--------|-----|
| Products, Plans, Features | BillingOS DB | Fast queries, merchant-specific |
| Subscriptions (list) | BillingOS DB | Fast, cached |
| Subscription (current status) | Stripe API | Real-time accuracy |
| Usage Records | BillingOS DB | Our tracking system |
| Payment Methods | Stripe API | Stripe is source of truth |
| Invoices (list) | BillingOS DB | Fast queries |
| Invoice PDFs | Stripe API | Generated by Stripe |

### Sync Pattern (Webhooks)

```
Stripe Event
    â”‚
    â”‚ (e.g., subscription.updated)
    â”‚
    â–¼
BillingOS Webhook Handler
    â”‚
    â”‚ Validates signature
    â”‚ Queues in PGMQ
    â”‚
    â–¼
Background Worker
    â”‚
    â”‚ Processes event
    â”‚ Updates database
    â”‚
    â–¼
SDK Refetches Data
    â”‚
    â”‚ React Query cache invalidated
    â”‚
    â–¼
UI Updates
```

---

## ğŸ› ï¸ Tech Stack

### Frontend (SDK)
- **React** - UI framework
- **TypeScript** - Type safety
- **Tailwind CSS** - Styling
- **Stripe Elements** - Payment forms
- **React Query** - Data fetching/caching
- **Framer Motion** - Animations

### Backend (BillingOS API)
- **NestJS** - API framework
- **PostgreSQL** - Database (via Supabase)
- **Stripe** - Payment processing
- **JWT** - Customer tokens

---

## ğŸ“ Developer Onboarding

### Week 1: Setup + First Component
**Goal:** Get PricingTable working with dummy data

**Steps:**
1. Set up project (npm install, TypeScript, Tailwind)
2. Read `docs/GETTING_STARTED.md`
3. Read `docs/component-specs/pricing-table-spec.md`
4. Build PricingTable with dummy data
5. Create demo app
6. Run locally and see pricing table

**Success:** Beautiful pricing table displaying in browser

### Week 2: More Components
**Goal:** Build UpgradeNudge and PaymentBottomSheet shell

**Steps:**
1. Build UpgradeNudge (banner/toast/modal variants)
2. Build PaymentBottomSheet UI (no Stripe yet)
3. Wire PricingTable â†’ PaymentBottomSheet

**Success:** Clicking "Buy Now" opens payment sheet

### Week 3: CustomerPortal
**Goal:** Build tabs and navigation

**Steps:**
1. Build portal shell with tabs
2. Build Subscription tab
3. Build Invoices tab
4. Build Payment Methods tab
5. Build Settings tab

**Success:** All tabs navigable with dummy data

### Week 4: Stripe Integration
**Goal:** Real payment processing

**Steps:**
1. Set up Stripe Elements
2. Implement checkout flow
3. Handle payment success/failure
4. Test with test cards

**Success:** Can complete a test payment

### Week 5: API Integration
**Goal:** Connect to real backend

**Steps:**
1. Build API client
2. Create React Query hooks
3. Replace dummy data with API calls
4. Add loading/error states

**Success:** Components fetch real data from backend

### Week 6: Polish
**Goal:** Production-ready

**Steps:**
1. Dark theme
2. Responsive design
3. Animations
4. Accessibility
5. Error handling
6. Documentation

**Success:** SDK ready to publish

---

## ğŸ§ª Testing Strategy

### Phase 1: Dummy Data (Week 1-3)
```tsx
import { DUMMY_PRODUCTS } from './dummy-data';

<PricingTable products={DUMMY_PRODUCTS.products} />
```

**Benefits:**
- No backend needed
- Fast iteration
- UI-focused development

### Phase 2: Mock API (Week 4)
```tsx
const mockClient = {
  getProducts: () => Promise.resolve(DUMMY_PRODUCTS),
  createCheckout: () => Promise.resolve({ clientSecret: 'test' })
};

<BillingOSProvider client={mockClient}>
  <PricingTable />
</BillingOSProvider>
```

**Benefits:**
- Test loading states
- Test error handling
- No real API calls

### Phase 3: Real API (Week 5+)
```tsx
<BillingOSProvider
  apiKey="pk_test_xyz"
  customerToken="eyJhbGc..."
>
  <PricingTable />
</BillingOSProvider>
```

**Benefits:**
- End-to-end testing
- Real data validation
- Performance testing

---

## ğŸ“Š Database Schema (Reference)

### Core Tables

**products**
- id, name, description
- recurring_interval (month/year)
- trial_days
- stripe_product_id

**product_prices**
- id, product_id
- amount, currency
- stripe_price_id

**features**
- id, organization_id
- name (technical key)
- title (display name)
- type (boolean_flag, usage_quota, numeric_limit)
- properties (JSONB config)

**product_features** (join table)
- product_id, feature_id
- display_order

**customers**
- id, email, name
- organization_id
- stripe_customer_id

**subscriptions**
- id, customer_id, product_id
- status, amount, currency
- current_period_start, current_period_end
- stripe_subscription_id

**feature_grants** (entitlements)
- customer_id, subscription_id, feature_id
- granted_at, revoked_at

**usage_records** (metering)
- customer_id, subscription_id, feature_id
- consumed_units, limit_units
- period_start, period_end

---

## ğŸ”Œ API Endpoints (Backend to Build)

### Authentication
- `POST /sdk/customer-tokens` - Create JWT token

### Products
- `GET /sdk/products` - List products with features

### Checkout
- `POST /sdk/checkout/create` - Create Payment Intent
- `POST /sdk/checkout/:clientSecret/confirm` - Confirm payment

### Customer Portal
- `GET /sdk/customer/portal` - All portal data

### Subscriptions
- `POST /sdk/subscriptions/:id/update` - Upgrade/downgrade
- `POST /sdk/subscriptions/:id/cancel` - Cancel subscription

### Payment Methods
- `POST /sdk/payment-methods` - Add card
- `DELETE /sdk/payment-methods/:id` - Remove card

### Usage
- `POST /sdk/usage/track` - Track feature usage
- `GET /sdk/usage/check` - Check nudge triggers

---

## âœ… Definition of Done

### For Each Component

- [ ] Built with TypeScript (no `any` types)
- [ ] Styled with Tailwind CSS
- [ ] Matches UI mockup from spec
- [ ] Works with dummy data
- [ ] Responsive (mobile/tablet/desktop)
- [ ] Loading states implemented
- [ ] Error states implemented
- [ ] Keyboard navigation works
- [ ] Screen reader accessible
- [ ] Added to demo app
- [ ] Tested in browser

### For Entire SDK

- [ ] All 4 components complete
- [ ] API client built
- [ ] React Query hooks created
- [ ] Authentication working (customer tokens)
- [ ] Stripe integration complete (payment processing)
- [ ] Dark theme working
- [ ] Documentation complete
- [ ] Example usage in README
- [ ] Published to npm (later)

---

## ğŸš¨ Common Pitfalls

### 1. Over-engineering Early
**Problem:** Trying to make components perfect before seeing them work
**Solution:** Start with dummy data, iterate quickly, polish later

### 2. Skipping Specs
**Problem:** Building without reading spec, missing requirements
**Solution:** Read full spec before coding, use dummy data provided

### 3. Premature API Integration
**Problem:** Trying to connect to API before UI is built
**Solution:** Build all components with dummy data first

### 4. Ignoring Mobile
**Problem:** Only designing for desktop
**Solution:** Mobile-first approach, test on phone simulator

### 5. Hardcoded Values
**Problem:** Styling with magic numbers instead of Tailwind
**Solution:** Use Tailwind utility classes consistently

---

## ğŸ“ Getting Help

### Documentation First
1. Check component spec for dummy data and examples
2. Check `GETTING_STARTED.md` for setup issues
3. Check `authentication-flow.md` for auth questions
4. Check `api-integration.md` for API endpoints

### Ask Questions
Include in your question:
- What you're trying to build
- What you tried
- What didn't work
- Error messages (if any)

### Code Review
Push code to GitHub and request review when:
- Component is complete
- Ready for API integration
- Need architecture feedback

---

## ğŸ‰ Success Metrics

### Week 1
- âœ… PricingTable renders with dummy data
- âœ… Demo app running locally

### Week 3
- âœ… All 4 components built
- âœ… Components navigable in demo app

### Week 5
- âœ… Connected to real API
- âœ… Can complete test payment

### Week 6
- âœ… Production-ready SDK
- âœ… Ready to publish to npm

---

## ğŸ“¦ Deliverables

### For Frontend Team
1. All component code (`src/components/`)
2. Demo app (`examples/demo-app/`)
3. Component documentation
4. Usage examples

### For Backend Team
1. All API endpoints (`/sdk/*`)
2. Authentication middleware (guards)
3. Webhook handlers
4. API documentation

### For Users (Merchants)
1. Published npm package
2. Installation guide
3. Integration examples
3. TypeScript types
4. Support documentation

---

## ğŸš€ You're Ready!

Everything you need is documented:
- âœ… Authentication flow explained
- âœ… All API endpoints specified
- âœ… All components spec'd with dummy data
- âœ… Setup guide complete
- âœ… Testing strategy defined

**Next step:** Open `docs/GETTING_STARTED.md` and start building!

Good luck! ğŸ‰
